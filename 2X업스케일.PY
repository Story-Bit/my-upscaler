import os
import subprocess
import sys

def upscale_image(input_image, output_image):
    print("Step 1: Real-ESRGAN ì—…ìŠ¤ì¼€ì¼ (x2) ì‹œì‘...")

    # ğŸ”¥ Windows ê²½ë¡œ ì‚­ì œí•˜ê³  Render ì„œë²„ì— ë§ê²Œ ë³€ê²½
    script_path = "/opt/render/project/src/Real-ESRGAN/inference_realesrgan.py"
    
    if not os.path.exists(script_path):
        raise FileNotFoundError(f"'{script_path}' íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Real-ESRGANì´ ì •ìƒì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆëŠ”ì§€ í™•ì¸ í•„ìš”)")

    # ì…ë ¥ ì´ë¯¸ì§€ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    if not os.path.exists(input_image):
        raise FileNotFoundError(f"ì…ë ¥ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {input_image}")

    output_folder = os.path.dirname(output_image)
    if not os.path.exists(output_folder):
        os.makedirs(output_folder)

    try:
        print(f"ì—…ìŠ¤ì¼€ì¼ ì¤‘: {input_image} -> {output_image}")
        subprocess.run(
            [
                sys.executable, script_path,
                "-i", input_image,
                "-o", output_image,
                "-n", "RealESRGAN_x2plus",
                "-g", "-1",
                "--fp32"
            ],
            check=True
        )

        if os.path.exists(output_image):
            print(f"[SUCCESS] ë³€í™˜ ì™„ë£Œ: {output_image}")
        else:
            raise FileNotFoundError(f"[ERROR] ë³€í™˜ëœ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {output_image}")
    
    except subprocess.CalledProcessError as e:
        print(f"[ERROR] ì—…ìŠ¤ì¼€ì¼ë§ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {input_image} -> {e}")
        raise RuntimeError(f"[ERROR] '{input_image}' ì—…ìŠ¤ì¼€ì¼ ì‹¤íŒ¨.")

    print("Real-ESRGAN ì—…ìŠ¤ì¼€ì¼ ì™„ë£Œ.")

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("ì‚¬ìš©ë²•: python 2Xì—…ìŠ¤ì¼€ì¼.PY <ì…ë ¥ ì´ë¯¸ì§€ ê²½ë¡œ> <ì¶œë ¥ ì´ë¯¸ì§€ ê²½ë¡œ>")
        sys.exit(1)

    input_image = sys.argv[1]
    output_image = sys.argv[2]

    upscale_image(input_image, output_image)
